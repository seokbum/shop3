<div class="card" style="width: 350px; height: 450px; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <span>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</span>
        <button class="btn btn-sm btn-light" onclick="$('#chat-box-container').empty(); window.chatOpen = false;">âœ–</button>
    </div>
    <div class="card-body d-flex flex-column">
        <textarea name="chatMsg" class="form-control mb-2" rows="10" readonly style="background-color: #f8f9fa; resize: none;"></textarea>
        <input type="text" name="chatInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
    </div>
</div>

<script th:inline="javascript">
    $(function(){
        // WebSocket ì„œë²„ ì£¼ì†Œ (í•„ìš”ì‹œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
        // const wsUrl = "ws://" + location.host + [[@{/chatting}]];
        const wsUrl = "ws://localhost:8083/chatting";
        let ws = new WebSocket(wsUrl);

        // ë¡œê·¸ì¸í•œ ìœ ì € ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸° (ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ê¶Œì¥)
        const loginUser = /*[[${session.loginUser?.userid}]]*/ 'guest';

        // ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ ì‹œ
        ws.onopen = function(){
            console.log("ì›¹ì†Œì¼“ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ì—”í„° í‚¤ë¥¼ ëˆ„ë¥´ë©´ ë©”ì‹œì§€ ì „ì†¡
            $("input[name=chatInput]").on("keydown", function(evt){
                if(evt.keyCode == 13){
                    const chatInput = $(this);
                    let msg = chatInput.val();
                    if (msg.trim() !== "") {
                        // ë©”ì‹œì§€ í˜•ì‹: "ì•„ì´ë””: ë©”ì‹œì§€"
                        ws.send(loginUser + ": " + msg);
                        chatInput.val("");
                    }
                }
            });
        };

        // ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
        ws.onmessage = function(event){
            let area = $("textarea[name=chatMsg]");
            // ìƒˆ ë©”ì‹œì§€ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€
            area.val(event.data + "\n" + area.val());
        };

        // ì—°ê²° ì¢…ë£Œ ì‹œ
        ws.onclose = function(){
            console.log("ì›¹ì†Œì¼“ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            // í•„ìš”ì‹œ ì¬ì—°ê²° ë¡œì§ ì¶”ê°€
        };

        // ì—ëŸ¬ ë°œìƒ ì‹œ
        ws.onerror = function(error) {
            console.error("ì›¹ì†Œì¼“ ì—ëŸ¬ ë°œìƒ: ", error);
        };

        // ì±„íŒ…ì°½ì´ ë‹«í ë•Œ ì›¹ì†Œì¼“ ì—°ê²°ë„ í•¨ê»˜ ì¢…ë£Œ
        $('#chat-box-container').on('DOMNodeRemoved', function(e) {
            if ($(e.target).hasClass('card')) {
                ws.close();
            }
        });
    });
</script>